<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IFR Ear Training Studio</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }
        
        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-style: italic;
        }
        
        .mode-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .mode-btn {
            padding: 12px 24px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .mode-btn:hover {
            background: #f0f0f0;
        }
        
        .mode-btn.active {
            background: #667eea;
            color: white;
        }
        
        .practice-area {
            background: #f9f9f9;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .keyboard {
            display: flex;
            justify-content: center;
            margin: 30px 0;
            height: 200px;
        }

        .keyboard-inner {
            position: relative;
            display: flex;
        }
        
        .key {
            position: relative;
            cursor: pointer;
            transition: all 0.1s;
        }
        
        .white-key {
            width: 50px;
            height: 200px;
            background: white;
            border: 2px solid #333;
            border-radius: 0 0 5px 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            padding-bottom: 10px;
            font-size: 12px;
            color: #666;
        }
        
        .white-key .note-name {
            font-size: 11px;
            margin-bottom: 3px;
        }
        
        .white-key .degree-label {
            font-size: 14px;
            font-weight: bold;
            color: #667eea;
        }
        
        .white-key:hover {
            background: #f0f0f0;
        }
        
        .white-key.active {
            background: #ffd700;
        }
        
        .white-key.root {
            background: #667eea;
            color: white;
        }
        
        .black-key {
            width: 30px;
            height: 120px;
            background: #333;
            border: 2px solid #000;
            border-radius: 0 0 3px 3px;
            position: absolute;
            z-index: 2;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            padding-bottom: 5px;
            font-size: 10px;
            font-weight: bold;
        }
        
        .black-key .note-name {
            font-size: 9px;
            margin-bottom: 2px;
        }
        
        .black-key .degree-label {
            font-size: 11px;
            font-weight: bold;
            color: #ffd700;
        }
        
        .black-key:hover {
            background: #555;
        }
        
        .black-key.active {
            background: #ffd700;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 15px 30px;
            font-size: 18px;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        .btn-secondary {
            background: #764ba2;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #653a8d;
            transform: translateY(-2px);
        }
        
        .answer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .answer-btn {
            padding: 15px;
            font-size: 16px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
        }
        
        .answer-btn:hover {
            background: #f0f0ff;
            transform: scale(1.05);
        }
        
        .answer-btn.correct {
            background: #4caf50;
            color: white;
            border-color: #4caf50;
        }
        
        .answer-btn.incorrect {
            background: #f44336;
            color: white;
            border-color: #f44336;
        }
        
        .feedback {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            margin: 20px 0;
            min-height: 30px;
        }
        
        .feedback.correct {
            color: #4caf50;
        }
        
        .feedback.incorrect {
            color: #f44336;
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            margin: 30px 0;
            padding: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-value {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        
        .harmonic-env {
            margin: 20px 0;
            padding: 15px;
            background: white;
            border-radius: 10px;
            text-align: center;
        }
        
        .harmonic-env h3 {
            color: #764ba2;
            margin-bottom: 10px;
        }
        
        .scale-degrees {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .degree {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .degree.active {
            background: #ffd700;
            color: #333;
            transform: scale(1.2);
        }
        
        .melody-controls {
            display: flex;
            gap: 20px;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .length-selector {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .length-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .length-btn:hover {
            background: #f0f0ff;
        }
        
        .length-btn.active {
            background: #667eea;
            color: white;
        }
        
        .playback-options {
            display: flex;
            gap: 10px;
        }
        
        .playback-btn {
            padding: 10px 20px;
            border: 2px solid #764ba2;
            background: white;
            color: #764ba2;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            font-weight: 600;
        }
        
        .playback-btn:hover {
            background: #f8f0ff;
        }
        
        .playback-btn.active {
            background: #764ba2;
            color: white;
        }
        
        .melody-display {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            min-height: 60px;
            align-items: center;
        }
        
        .melody-note {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            position: relative;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .melody-note.correct {
            background: #4caf50;
        }
        
        .melody-note.incorrect {
            background: #f44336;
        }
        
        .melody-note.user {
            background: #764ba2;
        }
        
        .melody-note .scale-degree {
            position: absolute;
            bottom: -25px;
            font-size: 12px;
            color: #666;
        }
        
        .recording-status {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            color: #764ba2;
            margin: 10px 0;
            min-height: 25px;
        }
        
        .user-melody {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            min-height: 60px;
            align-items: center;
        }
        
        .submit-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }
        
        .btn-submit {
            background: #4caf50;
            color: white;
        }
        
        .btn-submit:hover {
            background: #45a049;
        }
        
        .btn-clear {
            background: #ff9800;
            color: white;
        }
        
        .btn-clear:hover {
            background: #e68900;
        }
        
        .chord-info {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .chord-info h3 {
            color: #764ba2;
            margin-bottom: 10px;
            font-size: 20px;
        }
        
        .root-display {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }
        
        .chord-tones {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .chord-tone {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        
        .chord-tone .degree {
            font-size: 10px;
            margin-top: 2px;
        }
        
        .playback-mode {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 15px 0;
        }
        
        .scale-degree-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
            margin: 20px 0;
        }
        
        .env-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }
        
        .env-btn {
            padding: 8px 16px;
            border: 2px solid #764ba2;
            background: white;
            color: #764ba2;
            border-radius: 15px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            font-weight: 600;
        }
        
        .env-btn:hover {
            background: #f8f0ff;
        }
        
        .env-btn.active {
            background: #764ba2;
            color: white;
        }
        
        .sequence-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .reference-toggle {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .toggle-label {
            font-weight: bold;
            color: #667eea;
        }
        
        .scale-pattern {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .scale-note {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: #e0e0e0;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .scale-note.in-scale {
            background: #667eea;
            color: white;
        }
        
        .scale-note.current {
            background: #ffd700;
            color: #333;
            transform: scale(1.2);
        }
        
        .degree-answer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéµ IFR Ear Training Studio</h1>
        <p class="subtitle">Improvise for Real ‚Ä¢ Ear Training & Interval Recognition</p>
        
        <div class="mode-selector">
            <button class="mode-btn active" data-mode="intervals">Interval Recognition</button>
            <button class="mode-btn" data-mode="melodic">Melodic Dictation</button>
            <button class="mode-btn" data-mode="chords">Chord Quality</button>
            <button class="mode-btn" data-mode="scale-degrees">Scale Degrees</button>
        </div>
        
        <div class="stats">
            <div class="stat">
                <div class="stat-value" id="correct-count">0</div>
                <div class="stat-label">Correct</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="total-count">0</div>
                <div class="stat-label">Total</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="accuracy">0%</div>
                <div class="stat-label">Accuracy</div>
            </div>
        </div>
        
        <div class="practice-area">
            <div class="harmonic-env" id="harmonic-env">
                <h3>Harmonic Environment: <span id="env-name">Major (1)</span></h3>
                <div class="scale-degrees" id="scale-degrees"></div>
            </div>
            
            <!-- Melodic Dictation Controls -->
            <div class="melody-controls" id="melody-controls" style="display: none;">
                <div class="env-selector" style="margin-bottom: 10px;">
                    <span class="toggle-label">Harmonic Environment:</span>
                    <button class="env-btn melody-env-btn active" data-melody-env="1">1 Major</button>
                    <button class="env-btn melody-env-btn" data-melody-env="2">2 Minor</button>
                    <button class="env-btn melody-env-btn" data-melody-env="3">3 Mixolydian</button>
                    <button class="env-btn melody-env-btn" data-melody-env="4">4 Lydian</button>
                    <button class="env-btn melody-env-btn" data-melody-env="5">5 Phrygian</button>
                    <button class="env-btn melody-env-btn" data-melody-env="6">6 Dorian</button>
                    <button class="env-btn melody-env-btn" data-melody-env="7">7 Locrian</button>
                </div>
                <div class="length-selector">
                    <span style="font-weight: bold; color: #667eea;">Length:</span>
                    <button class="length-btn" data-length="3">3</button>
                    <button class="length-btn active" data-length="4">4</button>
                    <button class="length-btn" data-length="5">5</button>
                    <button class="length-btn" data-length="6">6</button>
                    <button class="length-btn" data-length="7">7</button>
                </div>
                <div class="playback-options">
                    <button class="playback-btn melody-style-btn active" data-style="separated">Separated</button>
                    <button class="playback-btn melody-style-btn" data-style="smooth">Smooth</button>
                    <button class="playback-btn melody-style-btn" data-style="step">Step-Through</button>
                </div>
            </div>
            
            <!-- Chord Quality Controls -->
            <div class="chord-info" id="chord-info" style="display: none;">
                <h3>Root Note: <span class="root-display" id="root-display">C</span></h3>
                <div class="playback-mode">
                    <button class="playback-btn chord-style-btn active" data-chord-style="block">Block Chord</button>
                    <button class="playback-btn chord-style-btn" data-chord-style="arpeggio">Arpeggiated</button>
                </div>
                <div class="chord-tones" id="chord-tones"></div>
            </div>
            
            <!-- Scale Degrees Controls -->
            <div class="scale-degree-controls" id="scale-degree-controls" style="display: none;">
                <div class="env-selector">
                    <span class="toggle-label">Harmonic Environment:</span>
                    <button class="env-btn active" data-env="1">1 Major</button>
                    <button class="env-btn" data-env="2">2 Minor</button>
                    <button class="env-btn" data-env="3">3 Mixolydian</button>
                    <button class="env-btn" data-env="4">4 Lydian</button>
                    <button class="env-btn" data-env="5">5 Phrygian</button>
                    <button class="env-btn" data-env="6">6 Dorian</button>
                    <button class="env-btn" data-env="7">7 Locrian</button>
                </div>
                <div class="sequence-controls">
                    <span class="toggle-label">Mode:</span>
                    <button class="playback-btn sequence-btn active" data-sequence="single">Single Note</button>
                    <button class="playback-btn sequence-btn" data-sequence="sequence">2-3 Note Sequence</button>
                </div>
                <div class="reference-toggle">
                    <span class="toggle-label">Play Reference (1):</span>
                    <button class="playback-btn reference-btn active" data-reference="yes">Yes</button>
                    <button class="playback-btn reference-btn" data-reference="no">No</button>
                </div>
            </div>
            
            <div class="scale-pattern" id="scale-pattern" style="display: none;"></div>
            
            <div class="recording-status" id="degree-status"></div>
            <div class="user-melody" id="user-degrees"></div>
            
            <div class="melody-display" id="melody-display"></div>
            <div class="recording-status" id="recording-status"></div>
            <div class="user-melody" id="user-melody"></div>
            
            <div class="submit-controls" id="submit-controls" style="display: none;">
                <button class="btn btn-clear" id="clear-melody-btn">üóëÔ∏è Clear & Try Again</button>
                <button class="btn btn-submit" id="submit-melody-btn">‚úì Submit Answer</button>
            </div>
            
            <div class="submit-controls" id="step-controls" style="display: none;">
                <button class="btn btn-secondary" id="prev-note-btn">‚¨ÖÔ∏è Previous</button>
                <div id="step-status" style="margin: 0 15px; font-size: 18px; font-weight: bold; color: #667eea;"></div>
                <button class="btn btn-primary" id="next-note-btn">Next ‚û°Ô∏è</button>
                <button class="btn btn-submit" id="start-recording-btn" style="margin-left: 20px;">‚úì Ready to Play Back</button>
            </div>
            
            <div class="keyboard" id="keyboard"></div>
            
            <div class="controls">
                <button class="btn btn-primary" id="play-btn">üîä Play Interval</button>
                <button class="btn btn-secondary" id="replay-btn">üîÅ Replay</button>
            </div>
            
            <div class="feedback" id="feedback"></div>
            
            <div class="answer-grid" id="answer-grid"></div>
        </div>
    </div>
    
    <script>
        // Audio context for piano sounds
        let audioContext;
        let currentMode = 'intervals';
        let currentInterval = null;
        let currentNotes = [];
        let correctCount = 0;
        let totalCount = 0;
        let activeKeys = [];
        
        // Melodic dictation variables
        let melodyLength = 4;
        let playbackStyle = 'separated';
        let currentMelody = [];
        let userMelody = [];
        let isRecording = false;
        let melodyEnv = 1;
        let currentStepIndex = 0;
        
        // Chord quality variables
        let chordPlayStyle = 'block';
        let currentChord = null;
        
        // Scale degrees variables
        let scaleSequenceMode = 'single'; // 'single' or 'sequence'
        let playReference = true;
        let selectedEnv = 1;
        let currentScaleDegrees = [];
        let targetDegrees = [];
        let userDegreeAnswer = [];
        // Scale patterns for each harmonic environment (in semitones from root)
        const scalePatterns = {
            1: { name: 'Major', pattern: [0, 2, 4, 5, 7, 9, 11], degrees: ['1', '2', '3', '4', '5', '6', '7'] },
            2: { name: 'Minor', pattern: [0, 2, 3, 5, 7, 8, 10], degrees: ['1', '2', '‚ô≠3', '4', '5', '‚ô≠6', '‚ô≠7'] },
            3: { name: 'Mixolydian', pattern: [0, 2, 4, 5, 7, 9, 10], degrees: ['1', '2', '3', '4', '5', '6', '‚ô≠7'] },
            4: { name: 'Lydian', pattern: [0, 2, 4, 6, 7, 9, 11], degrees: ['1', '2', '3', '‚ôØ4', '5', '6', '7'] },
            5: { name: 'Phrygian', pattern: [0, 1, 3, 5, 7, 8, 10], degrees: ['1', '‚ô≠2', '‚ô≠3', '4', '5', '‚ô≠6', '‚ô≠7'] },
            6: { name: 'Dorian', pattern: [0, 2, 3, 5, 7, 9, 10], degrees: ['1', '2', '‚ô≠3', '4', '5', '6', '‚ô≠7'] },
            7: { name: 'Locrian', pattern: [0, 1, 3, 5, 6, 8, 10], degrees: ['1', '‚ô≠2', '‚ô≠3', '4', '‚ô≠5', '‚ô≠6', '‚ô≠7'] }
        };
        
        // All possible chromatic degrees
        const chromaticDegrees = ['1', '‚ô≠2', '2', '‚ô≠3', '3', '4', '‚ôØ4', '5', '‚ô≠6', '6', '‚ô≠7', '7'];
        
        // Basic chord qualities (starting simple)
        const chordQualities = {
            'Major': [0, 4, 7],
            'Minor': [0, 3, 7],
            'Diminished': [0, 3, 6],
            'Augmented': [0, 4, 8],
            'Major 7th': [0, 4, 7, 11],
            'Minor 7th': [0, 3, 7, 10],
            'Dominant 7th': [0, 4, 7, 10],
            'Diminished 7th': [0, 3, 6, 9],
            'Half-Diminished 7th': [0, 3, 6, 10]
        };
        
        // IFR Harmonic Environments
        const harmonicEnvironments = {
            1: { name: 'Major', degrees: [1, 2, 3, 4, 5, 6, 7] },
            2: { name: 'Minor', degrees: [1, 2, 3, 4, 5, 6, 7] },
            3: { name: 'Mixolydian', degrees: [1, 2, 3, 4, 5, 6, 7] },
            4: { name: 'Lydian', degrees: [1, 2, 3, 4, 5, 6, 7] },
            5: { name: 'Phrygian', degrees: [1, 2, 3, 4, 5, 6, 7] },
            6: { name: 'Dorian', degrees: [1, 2, 3, 4, 5, 6, 7] },
            7: { name: 'Locrian', degrees: [1, 2, 3, 4, 5, 6, 7] }
        };
        
        let currentEnv = 1;
        
        // Intervals within two octave range (up to octave + major 7th = 23 semitones)
        const intervals = [
            { name: 'Unison', semitones: 0 },
            { name: 'Minor 2nd', semitones: 1 },
            { name: 'Major 2nd', semitones: 2 },
            { name: 'Minor 3rd', semitones: 3 },
            { name: 'Major 3rd', semitones: 4 },
            { name: 'Perfect 4th', semitones: 5 },
            { name: 'Tritone', semitones: 6 },
            { name: 'Perfect 5th', semitones: 7 },
            { name: 'Minor 6th', semitones: 8 },
            { name: 'Major 6th', semitones: 9 },
            { name: 'Minor 7th', semitones: 10 },
            { name: 'Major 7th', semitones: 11 },
            { name: 'Octave', semitones: 12 },
            { name: 'Minor 9th', semitones: 13 },
            { name: 'Major 9th', semitones: 14 },
            { name: 'Minor 10th', semitones: 15 },
            { name: 'Major 10th', semitones: 16 },
            { name: 'Perfect 11th', semitones: 17 },
            { name: 'Augmented 11th', semitones: 18 },
            { name: 'Perfect 12th', semitones: 19 },
            { name: 'Minor 13th', semitones: 20 },
            { name: 'Major 13th', semitones: 21 },
            { name: 'Minor 14th', semitones: 22 },
            { name: 'Major 14th', semitones: 23 }
        ];
        
        // Initialize audio context
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }
        
        // Generate piano tone
        function playNote(frequency, duration = 1, startTime = 0) {
            initAudio();
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = frequency;
            oscillator.type = 'sine';
            
            const now = audioContext.currentTime + startTime;
            gainNode.gain.setValueAtTime(0.3, now);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + duration);
            
            oscillator.start(now);
            oscillator.stop(now + duration);
        }
        
        // Convert MIDI note to frequency
        function midiToFreq(midi) {
            return 440 * Math.pow(2, (midi - 69) / 12);
        }
        
        // Get scale degree from MIDI note (relative to C)
        function getScaleDegree(midi) {
            const noteInOctave = midi % 12;
            const degreeMap = {
                0: '1',   // C
                1: '‚ô≠2',  // C#
                2: '2',   // D
                3: '‚ô≠3',  // D#
                4: '3',   // E
                5: '4',   // F
                6: '‚ôØ4',  // F#
                7: '5',   // G
                8: '‚ô≠6',  // G#
                9: '6',   // A
                10: '‚ô≠7', // A#
                11: '7'   // B
            };
            return degreeMap[noteInOctave];
        }
        
        // Get note name from MIDI
        function getNoteName(midi) {
            const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            const octave = Math.floor(midi / 12) - 1;
            return noteNames[midi % 12] + octave;
        }
        
        // Create keyboard
        function createKeyboard() {
            const keyboard = document.getElementById('keyboard');
            keyboard.innerHTML = '';

            const inner = document.createElement('div');
            inner.className = 'keyboard-inner';
            keyboard.appendChild(inner);

            const whiteKeys = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
            const startMidi = 60; // Middle C (C4)

            // Create white keys first
            for (let octave = 0; octave < 2; octave++) {
                for (let i = 0; i < 7; i++) {
                    const noteName = whiteKeys[i] + (4 + octave);
                    const midiNote = startMidi + octave * 12 + [0, 2, 4, 5, 7, 9, 11][i];

                    const whiteKey = document.createElement('div');
                    whiteKey.className = 'key white-key';
                    whiteKey.dataset.midi = midiNote;
                    whiteKey.innerHTML = `<div class="degree-label">${getScaleDegree(midiNote)}</div><div class="note-name">${noteName}</div>`;

                    if (octave === 0 && i === 0) whiteKey.classList.add('root');

                    whiteKey.addEventListener('click', () => {
                        const midi = parseInt(whiteKey.dataset.midi);
                        if (currentMode === 'melodic' && isRecording) {
                            recordNote(midi);
                        } else {
                            playNote(midiToFreq(midi), 0.5);
                        }
                    });

                    inner.appendChild(whiteKey);
                }
            }

            // Add the final C at the top
            const finalC = document.createElement('div');
            finalC.className = 'key white-key';
            finalC.dataset.midi = startMidi + 24;
            finalC.innerHTML = `<div class="degree-label">${getScaleDegree(startMidi + 24)}</div><div class="note-name">C6</div>`;
            finalC.addEventListener('click', () => {
                playNote(midiToFreq(parseInt(finalC.dataset.midi)), 0.5);
            });
            inner.appendChild(finalC);

            // Create black keys - positioned between appropriate white keys
            // Black keys appear after: C, D, F, G, A (not after E or B)
            const blackKeyPattern = [
                { afterWhite: 0, semitone: 1, name: 'C#' },  // C#
                { afterWhite: 1, semitone: 3, name: 'D#' },  // D#
                { afterWhite: 3, semitone: 6, name: 'F#' },  // F#
                { afterWhite: 4, semitone: 8, name: 'G#' },  // G#
                { afterWhite: 5, semitone: 10, name: 'A#' }  // A#
            ];

            for (let octave = 0; octave < 2; octave++) {
                blackKeyPattern.forEach(black => {
                    const midiNote = startMidi + octave * 12 + black.semitone;
                    const whiteKeyPosition = octave * 7 + black.afterWhite;
                    const noteName = black.name + (4 + octave);

                    const blackKey = document.createElement('div');
                    blackKey.className = 'key black-key';
                    blackKey.dataset.midi = midiNote;
                    blackKey.innerHTML = `<div class="degree-label">${getScaleDegree(midiNote)}</div><div class="note-name">${noteName}</div>`;
                    blackKey.style.left = (whiteKeyPosition * 52 + 37) + 'px';

                    blackKey.addEventListener('click', () => {
                        const midi = parseInt(blackKey.dataset.midi);
                        if (currentMode === 'melodic' && isRecording) {
                            recordNote(midi);
                        } else {
                            playNote(midiToFreq(midi), 0.5);
                        }
                    });

                    inner.appendChild(blackKey);
                });
            }
        }
        
        // Highlight keys on keyboard
        function highlightKeys(midiNotes) {
            const keys = document.querySelectorAll('.key');
            keys.forEach(key => {
                key.classList.remove('active');
                if (midiNotes.includes(parseInt(key.dataset.midi))) {
                    key.classList.add('active');
                }
            });
        }
        
        // Update scale degrees display
        function updateScaleDegrees() {
            const container = document.getElementById('scale-degrees');
            container.innerHTML = '';
            
            const env = harmonicEnvironments[currentEnv];
            env.degrees.forEach(degree => {
                const degreeEl = document.createElement('div');
                degreeEl.className = 'degree';
                degreeEl.textContent = degree;
                container.appendChild(degreeEl);
            });
            
            document.getElementById('env-name').textContent = `${env.name} (${currentEnv})`;
        }
        
        // Play interval
        function playInterval() {
            initAudio();
            
            const keyboardStart = 60; // Middle C (C4)
            const keyboardEnd = 84; // C6 (two octaves up)
            const keyboardRange = keyboardEnd - keyboardStart; // 24 semitones
            
            const interval = intervals[Math.floor(Math.random() * intervals.length)];
            const direction = Math.random() > 0.5 ? 1 : -1; // Ascending or descending
            
            currentInterval = { ...interval, direction };
            
            // Calculate notes ensuring both stay within keyboard range
            let note1, note2;
            
            if (direction > 0) {
                // Ascending: start note must allow interval to fit
                const maxStart = keyboardEnd - interval.semitones;
                note1 = keyboardStart + Math.floor(Math.random() * (maxStart - keyboardStart + 1));
                note2 = note1 + interval.semitones;
            } else {
                // Descending: start note must allow interval to fit
                const minStart = keyboardStart + interval.semitones;
                note1 = minStart + Math.floor(Math.random() * (keyboardEnd - minStart + 1));
                note2 = note1 - interval.semitones;
            }
            
            currentNotes = [note1, note2];
            
            // Play notes
            playNote(midiToFreq(note1), 1, 0);
            playNote(midiToFreq(note2), 1, 1);
            
            // Highlight on keyboard after a moment
            setTimeout(() => {
                highlightKeys(currentNotes);
            }, 100);
            
            document.getElementById('feedback').textContent = '';
        }
        
        // Generate and play melody
        function playMelody() {
            initAudio();
            
            const root = 60; // C4
            const pattern = scalePatterns[melodyEnv];
            
            // Generate random melody using notes from the selected harmonic environment
            currentMelody = [];
            for (let i = 0; i < melodyLength; i++) {
                const randomIndex = Math.floor(Math.random() * pattern.pattern.length);
                const semitone = pattern.pattern[randomIndex];
                
                // Randomly choose octave (4 or 5) to use full keyboard range
                const octaveShift = Math.random() > 0.5 ? 12 : 0;
                const note = root + semitone + octaveShift;
                
                currentMelody.push(note);
            }
            
            // Display melody circles (hidden until answered)
            displayMelody(currentMelody, false);
            
            // Handle step-through mode
            if (playbackStyle === 'step') {
                currentStepIndex = 0;
                document.getElementById('step-controls').style.display = 'flex';
                document.getElementById('step-status').textContent = `Note 1 of ${melodyLength}`;
                
                // Play first note
                playNote(midiToFreq(currentMelody[0]), 1, 0);
                highlightKeys([currentMelody[0]]);
                
                userMelody = [];
                document.getElementById('user-melody').innerHTML = '';
                document.getElementById('feedback').textContent = '';
                document.getElementById('submit-controls').style.display = 'none';
                return;
            }
            
            // Play melody normally for separated/smooth modes
            if (playbackStyle === 'separated') {
                currentMelody.forEach((note, i) => {
                    playNote(midiToFreq(note), 0.8, i * 1);
                    setTimeout(() => {
                        highlightKeys([note]);
                    }, i * 1000);
                });
            } else {
                currentMelody.forEach((note, i) => {
                    playNote(midiToFreq(note), 0.6, i * 0.4);
                    setTimeout(() => {
                        highlightKeys([note]);
                    }, i * 400);
                });
            }
            
            // Clear highlights after melody finishes
            const totalDuration = playbackStyle === 'separated' ? melodyLength * 1000 : melodyLength * 400;
            setTimeout(() => {
                highlightKeys([]);
                startRecording();
            }, totalDuration + 500);
            
            userMelody = [];
            document.getElementById('user-melody').innerHTML = '';
            document.getElementById('feedback').textContent = '';
            document.getElementById('submit-controls').style.display = 'none';
            document.getElementById('step-controls').style.display = 'none';
        }
        
        // Display melody
        function displayMelody(melody, showNotes = true) {
            const display = document.getElementById('melody-display');
            display.innerHTML = '';
            
            melody.forEach(note => {
                const noteEl = document.createElement('div');
                noteEl.className = 'melody-note';
                noteEl.innerHTML = showNotes ? `${getNoteName(note)}<div class="scale-degree">${getScaleDegree(note)}</div>` : '?';
                display.appendChild(noteEl);
            });
        }
        
        // Start recording user melody
        function startRecording() {
            isRecording = true;
            document.getElementById('recording-status').textContent = 'üéπ Click the keyboard to play back the melody...';
        }
        
        // Record note from keyboard
        function recordNote(midi) {
            if (!isRecording) return;
            
            userMelody.push(midi);
            playNote(midiToFreq(midi), 0.5);
            
            // Display user's melody
            const userDisplay = document.getElementById('user-melody');
            userDisplay.innerHTML = '';
            userMelody.forEach(note => {
                const noteEl = document.createElement('div');
                noteEl.className = 'melody-note user';
                noteEl.innerHTML = `${getNoteName(note)}<div class="scale-degree">${getScaleDegree(note)}</div>`;
                userDisplay.appendChild(noteEl);
            });
            
            // Show submit/clear buttons when user has played at least one note
            if (userMelody.length > 0) {
                document.getElementById('submit-controls').style.display = 'flex';
            }
        }
        
        // Check user's melody
        function checkMelody() {
            isRecording = false;
            document.getElementById('submit-controls').style.display = 'none';
            totalCount++;
            
            // Pad or truncate user melody to match expected length
            const correct = userMelody.length === melodyLength && 
                           JSON.stringify(currentMelody) === JSON.stringify(userMelody);
            
            if (correct) {
                correctCount++;
                document.getElementById('feedback').textContent = '‚úì Perfect! You got the melody!';
                document.getElementById('feedback').className = 'feedback correct';
            } else {
                let feedbackText = '‚úó Not quite. ';
                if (userMelody.length !== melodyLength) {
                    feedbackText += `Expected ${melodyLength} notes, you played ${userMelody.length}. `;
                }
                feedbackText += 'Here\'s the melody:';
                document.getElementById('feedback').textContent = feedbackText;
                document.getElementById('feedback').className = 'feedback incorrect';
            }
            
            // Show the correct melody with color coding
            displayMelody(currentMelody, true);
            
            // Color code the comparison (match positions)
            const melodyNotes = document.querySelectorAll('#melody-display .melody-note');
            const maxLength = Math.max(currentMelody.length, userMelody.length);
            
            melodyNotes.forEach((noteEl, i) => {
                if (i < userMelody.length && userMelody[i] === currentMelody[i]) {
                    noteEl.classList.add('correct');
                } else if (i < userMelody.length) {
                    noteEl.classList.add('incorrect');
                }
            });
            
            updateStats();
            document.getElementById('recording-status').textContent = '';
        }
        
        // Play chord
        function playChord() {
            initAudio();
            
            const keyboardStart = 60; // C4
            const keyboardEnd = 84; // C6
            
            // Pick random chord quality
            const qualityNames = Object.keys(chordQualities);
            const quality = qualityNames[Math.floor(Math.random() * qualityNames.length)];
            const intervals = chordQualities[quality];
            
            // Pick random root note within range that allows chord to fit
            const maxRoot = keyboardEnd - Math.max(...intervals);
            const root = keyboardStart + Math.floor(Math.random() * (maxRoot - keyboardStart + 1));
            
            // Pick random inversion (0 = root position, 1 = 1st inversion, etc.)
            const maxInversion = intervals.length - 1;
            const inversion = Math.floor(Math.random() * (maxInversion + 1));
            
            // Build chord notes with inversion
            let chordNotes = intervals.map(interval => root + interval);
            
            // Apply inversion by moving bottom notes up an octave
            for (let i = 0; i < inversion; i++) {
                chordNotes[i] += 12;
            }
            
            // Sort notes
            chordNotes.sort((a, b) => a - b);
            
            // Store current chord info
            currentChord = {
                quality: quality,
                root: root,
                notes: chordNotes,
                inversion: inversion
            };
            
            // Display root note
            document.getElementById('root-display').textContent = getNoteName(root);
            
            // Display chord tones with scale degrees
            const tonesDisplay = document.getElementById('chord-tones');
            tonesDisplay.innerHTML = '';
            chordNotes.forEach(note => {
                const toneEl = document.createElement('div');
                toneEl.className = 'chord-tone';
                toneEl.innerHTML = `${getNoteName(note)}<div class="degree">${getScaleDegree(note)}</div>`;
                tonesDisplay.appendChild(toneEl);
            });
            
            // Play chord
            if (chordPlayStyle === 'block') {
                // All notes at once
                chordNotes.forEach(note => {
                    playNote(midiToFreq(note), 2, 0);
                });
            } else {
                // Arpeggiated
                chordNotes.forEach((note, i) => {
                    playNote(midiToFreq(note), 1, i * 0.3);
                });
            }
            
            // Highlight on keyboard
            setTimeout(() => {
                highlightKeys(chordNotes);
            }, 100);
            
            document.getElementById('feedback').textContent = '';
            
            // Show answer buttons
            createChordAnswerButtons();
        }
        
        // Create chord answer buttons
        function createChordAnswerButtons() {
            const grid = document.getElementById('answer-grid');
            grid.innerHTML = '';
            
            Object.keys(chordQualities).forEach(quality => {
                const btn = document.createElement('button');
                btn.className = 'answer-btn';
                btn.textContent = quality;
                btn.addEventListener('click', () => checkChordAnswer(quality));
                grid.appendChild(btn);
            });
        }
        
        // Check chord answer
        function checkChordAnswer(answer) {
            if (!currentChord) return;
            
            totalCount++;
            const isCorrect = answer === currentChord.quality;
            
            if (isCorrect) {
                correctCount++;
                const inversionText = currentChord.inversion === 0 ? 'Root Position' : 
                                     currentChord.inversion === 1 ? '1st Inversion' :
                                     currentChord.inversion === 2 ? '2nd Inversion' : '3rd Inversion';
                document.getElementById('feedback').textContent = `‚úì Correct! ${currentChord.quality} (${inversionText})`;
                document.getElementById('feedback').className = 'feedback correct';
            } else {
                const inversionText = currentChord.inversion === 0 ? 'Root Position' : 
                                     currentChord.inversion === 1 ? '1st Inversion' :
                                     currentChord.inversion === 2 ? '2nd Inversion' : '3rd Inversion';
                document.getElementById('feedback').textContent = `‚úó Incorrect. That was ${currentChord.quality} (${inversionText})`;
                document.getElementById('feedback').className = 'feedback incorrect';
            }
            
            updateStats();
            
            // Highlight answer button
            const buttons = document.querySelectorAll('.answer-btn');
            buttons.forEach(btn => {
                if (btn.textContent === answer) {
                    btn.classList.add(isCorrect ? 'correct' : 'incorrect');
                    setTimeout(() => btn.classList.remove('correct', 'incorrect'), 1500);
                }
            });
        }
        
        // Display scale pattern
        function displayScalePattern() {
            const pattern = scalePatterns[selectedEnv];
            const container = document.getElementById('scale-pattern');
            container.innerHTML = '';
            
            chromaticDegrees.forEach((degree, index) => {
                const noteEl = document.createElement('div');
                noteEl.className = 'scale-note';
                
                // Check if this degree is in the current scale
                const semitone = index;
                if (pattern.pattern.includes(semitone)) {
                    noteEl.classList.add('in-scale');
                }
                
                noteEl.textContent = degree;
                container.appendChild(noteEl);
            });
        }
        
        // Play scale degree exercise
        function playScaleDegree() {
            initAudio();
            
            const root = 60; // C4
            const pattern = scalePatterns[selectedEnv];
            
            // Reset user answer
            userDegreeAnswer = [];
            document.getElementById('user-degrees').innerHTML = '';
            document.getElementById('degree-status').textContent = '';
            
            // Play reference note if enabled
            let startTime = 0;
            if (playReference) {
                playNote(midiToFreq(root), 1, 0);
                startTime = 1.5;
            }
            
            // Generate target note(s)
            if (scaleSequenceMode === 'single') {
                // Single note from the scale
                const randomIndex = Math.floor(Math.random() * pattern.pattern.length);
                const semitone = pattern.pattern[randomIndex];
                const targetNote = root + semitone;
                
                targetDegrees = [pattern.degrees[randomIndex]];
                currentScaleDegrees = [targetNote];
                
                playNote(midiToFreq(targetNote), 1, startTime);
                
                setTimeout(() => {
                    highlightKeys([targetNote]);
                }, startTime * 1000);
            } else {
                // 2-3 note sequence
                const sequenceLength = 2 + Math.floor(Math.random() * 2); // 2 or 3
                targetDegrees = [];
                currentScaleDegrees = [];
                
                for (let i = 0; i < sequenceLength; i++) {
                    const randomIndex = Math.floor(Math.random() * pattern.pattern.length);
                    const semitone = pattern.pattern[randomIndex];
                    const targetNote = root + semitone;
                    
                    targetDegrees.push(pattern.degrees[randomIndex]);
                    currentScaleDegrees.push(targetNote);
                    
                    playNote(midiToFreq(targetNote), 0.8, startTime + (i * 1));
                }
                
                setTimeout(() => {
                    highlightKeys(currentScaleDegrees);
                }, startTime * 1000);
            }
            
            // Highlight current degree(s) in scale pattern
            setTimeout(() => {
                updateScalePatternHighlight();
                
                // Show instruction for sequence mode
                if (scaleSequenceMode === 'sequence') {
                    document.getElementById('degree-status').textContent = 
                        `üéº Click the scale degrees in order (${targetDegrees.length} notes)...`;
                }
            }, (startTime + 0.1) * 1000);
            
            document.getElementById('feedback').textContent = '';
            
            // Show answer options
            createScaleDegreeAnswers();
        }
        
        // Update scale pattern highlighting
        function updateScalePatternHighlight() {
            const pattern = scalePatterns[selectedEnv];
            const scaleNotes = document.querySelectorAll('.scale-note');
            
            scaleNotes.forEach((note, index) => {
                note.classList.remove('current');
                
                // Highlight if this degree is in targetDegrees
                if (targetDegrees.includes(chromaticDegrees[index])) {
                    note.classList.add('current');
                }
            });
        }
        
        // Create scale degree answer buttons
        function createScaleDegreeAnswers() {
            const grid = document.getElementById('answer-grid');
            grid.innerHTML = '';
            grid.className = 'degree-answer-grid';
            
            const pattern = scalePatterns[selectedEnv];
            
            // Show buttons for scale degrees
            pattern.degrees.forEach(degree => {
                const btn = document.createElement('button');
                btn.className = 'answer-btn';
                btn.textContent = degree;
                
                if (scaleSequenceMode === 'sequence') {
                    btn.addEventListener('click', () => recordDegreeAnswer(degree));
                } else {
                    btn.addEventListener('click', () => checkScaleDegreeAnswer(degree));
                }
                
                grid.appendChild(btn);
            });
        }
        
        // Record scale degree answer for sequences
        function recordDegreeAnswer(degree) {
            userDegreeAnswer.push(degree);
            
            // Display user's answer
            const userDisplay = document.getElementById('user-degrees');
            userDisplay.innerHTML = '';
            userDegreeAnswer.forEach(deg => {
                const degEl = document.createElement('div');
                degEl.className = 'melody-note user';
                degEl.textContent = deg;
                userDisplay.appendChild(degEl);
            });
            
            // Check if complete
            if (userDegreeAnswer.length === targetDegrees.length) {
                checkScaleDegreeAnswer();
            } else {
                document.getElementById('degree-status').textContent = 
                    `üéº ${userDegreeAnswer.length}/${targetDegrees.length} - Keep going...`;
            }
        }
        
        // Check scale degree answer
        function checkScaleDegreeAnswer(answer) {
            totalCount++;
            document.getElementById('degree-status').textContent = '';
            
            let isCorrect = false;
            
            if (scaleSequenceMode === 'single') {
                isCorrect = answer === targetDegrees[0];
            } else {
                // For sequences, check if the entire sequence matches
                isCorrect = JSON.stringify(userDegreeAnswer) === JSON.stringify(targetDegrees);
            }
            
            if (isCorrect) {
                correctCount++;
                if (scaleSequenceMode === 'single') {
                    document.getElementById('feedback').textContent = `‚úì Correct! Scale degree ${targetDegrees[0]}`;
                } else {
                    document.getElementById('feedback').textContent = `‚úì Perfect! Sequence: ${targetDegrees.join(' ‚Üí ')}`;
                }
                document.getElementById('feedback').className = 'feedback correct';
            } else {
                if (scaleSequenceMode === 'single') {
                    document.getElementById('feedback').textContent = `‚úó Incorrect. That was scale degree ${targetDegrees[0]}`;
                } else {
                    document.getElementById('feedback').textContent = `‚úó Not quite. Sequence was: ${targetDegrees.join(' ‚Üí ')}`;
                }
                document.getElementById('feedback').className = 'feedback incorrect';
            }
            
            updateStats();
            
            // Highlight answer button (for single mode)
            if (scaleSequenceMode === 'single') {
                const buttons = document.querySelectorAll('.answer-btn');
                buttons.forEach(btn => {
                    if (btn.textContent === answer) {
                        btn.classList.add(isCorrect ? 'correct' : 'incorrect');
                        setTimeout(() => btn.classList.remove('correct', 'incorrect'), 1500);
                    }
                });
            }
        }
        
        // Create answer buttons
        function createAnswerButtons() {
            const grid = document.getElementById('answer-grid');
            grid.innerHTML = '';
            
            if (currentMode === 'intervals') {
                intervals.forEach(interval => {
                    const btn = document.createElement('button');
                    btn.className = 'answer-btn';
                    btn.textContent = interval.name;
                    btn.addEventListener('click', () => checkAnswer(interval.name));
                    grid.appendChild(btn);
                });
            }
        }
        
        // Check answer
        function checkAnswer(answer) {
            if (!currentInterval) return;
            
            totalCount++;
            const isCorrect = answer === currentInterval.name;
            
            if (isCorrect) {
                correctCount++;
                document.getElementById('feedback').textContent = '‚úì Correct! ' + 
                    (currentInterval.direction > 0 ? '‚Üó Ascending' : '‚Üò Descending');
                document.getElementById('feedback').className = 'feedback correct';
            } else {
                document.getElementById('feedback').textContent = '‚úó Incorrect. That was a ' + 
                    currentInterval.name + (currentInterval.direction > 0 ? ' ‚Üó Ascending' : ' ‚Üò Descending');
                document.getElementById('feedback').className = 'feedback incorrect';
            }
            
            updateStats();
            
            // Highlight answer button
            const buttons = document.querySelectorAll('.answer-btn');
            buttons.forEach(btn => {
                if (btn.textContent === answer) {
                    btn.classList.add(isCorrect ? 'correct' : 'incorrect');
                    setTimeout(() => btn.classList.remove('correct', 'incorrect'), 1500);
                }
            });
        }
        
        // Update statistics
        function updateStats() {
            document.getElementById('correct-count').textContent = correctCount;
            document.getElementById('total-count').textContent = totalCount;
            const accuracy = totalCount > 0 ? Math.round((correctCount / totalCount) * 100) : 0;
            document.getElementById('accuracy').textContent = accuracy + '%';
        }
        
        // Mode switching
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentMode = btn.dataset.mode;
                
                // Reset for new mode
                currentInterval = null;
                currentMelody = [];
                userMelody = [];
                isRecording = false;
                userDegreeAnswer = [];
                currentStepIndex = 0;
                document.getElementById('feedback').textContent = '';
                document.getElementById('melody-display').innerHTML = '';
                document.getElementById('user-melody').innerHTML = '';
                document.getElementById('user-degrees').innerHTML = '';
                document.getElementById('recording-status').textContent = '';
                document.getElementById('degree-status').textContent = '';
                document.getElementById('step-controls').style.display = 'none';
                highlightKeys([]);
                
                // Show/hide mode-specific controls
                if (currentMode === 'intervals') {
                    document.getElementById('answer-grid').style.display = 'grid';
                    document.getElementById('melody-controls').style.display = 'none';
                    document.getElementById('submit-controls').style.display = 'none';
                    document.getElementById('chord-info').style.display = 'none';
                    document.getElementById('scale-degree-controls').style.display = 'none';
                    document.getElementById('scale-pattern').style.display = 'none';
                    document.getElementById('harmonic-env').style.display = 'none';
                    document.getElementById('play-btn').textContent = 'üîä Play Interval';
                    createAnswerButtons();
                } else if (currentMode === 'melodic') {
                    document.getElementById('answer-grid').style.display = 'none';
                    document.getElementById('melody-controls').style.display = 'flex';
                    document.getElementById('submit-controls').style.display = 'none';
                    document.getElementById('chord-info').style.display = 'none';
                    document.getElementById('scale-degree-controls').style.display = 'none';
                    document.getElementById('scale-pattern').style.display = 'none';
                    document.getElementById('harmonic-env').style.display = 'block';
                    document.getElementById('play-btn').textContent = 'üéµ Play Melody';
                    updateMelodyEnvDisplay();
                } else if (currentMode === 'chords') {
                    document.getElementById('answer-grid').style.display = 'grid';
                    document.getElementById('melody-controls').style.display = 'none';
                    document.getElementById('submit-controls').style.display = 'none';
                    document.getElementById('chord-info').style.display = 'block';
                    document.getElementById('scale-degree-controls').style.display = 'none';
                    document.getElementById('scale-pattern').style.display = 'none';
                    document.getElementById('harmonic-env').style.display = 'none';
                    document.getElementById('play-btn').textContent = 'üéπ Play Chord';
                } else if (currentMode === 'scale-degrees') {
                    document.getElementById('answer-grid').style.display = 'grid';
                    document.getElementById('melody-controls').style.display = 'none';
                    document.getElementById('submit-controls').style.display = 'none';
                    document.getElementById('chord-info').style.display = 'none';
                    document.getElementById('scale-degree-controls').style.display = 'flex';
                    document.getElementById('scale-pattern').style.display = 'flex';
                    document.getElementById('harmonic-env').style.display = 'block';
                    document.getElementById('play-btn').textContent = 'üéº Play Scale Degree';
                    displayScalePattern();
                    updateScaleDegrees();
                } else {
                    document.getElementById('answer-grid').style.display = 'none';
                    document.getElementById('melody-controls').style.display = 'none';
                    document.getElementById('submit-controls').style.display = 'none';
                    document.getElementById('chord-info').style.display = 'none';
                    document.getElementById('scale-degree-controls').style.display = 'none';
                    document.getElementById('scale-pattern').style.display = 'none';
                    document.getElementById('harmonic-env').style.display = 'none';
                    document.getElementById('play-btn').textContent = 'üîä Play';
                }
            });
        });
        
        // Event listeners
        document.getElementById('play-btn').addEventListener('click', () => {
            if (currentMode === 'intervals') {
                playInterval();
            } else if (currentMode === 'melodic') {
                playMelody();
            } else if (currentMode === 'chords') {
                playChord();
            } else if (currentMode === 'scale-degrees') {
                playScaleDegree();
            }
        });
        
        document.getElementById('replay-btn').addEventListener('click', () => {
            if (currentMode === 'intervals' && currentNotes.length > 0) {
                playNote(midiToFreq(currentNotes[0]), 1, 0);
                playNote(midiToFreq(currentNotes[1]), 1, 1);
            } else if (currentMode === 'melodic' && currentMelody.length > 0) {
                if (playbackStyle === 'step') {
                    // In step-through mode, replay the current note
                    if (currentStepIndex >= 0 && currentStepIndex < currentMelody.length) {
                        playNote(midiToFreq(currentMelody[currentStepIndex]), 1, 0);
                        highlightKeys([currentMelody[currentStepIndex]]);
                    }
                } else if (playbackStyle === 'separated') {
                    currentMelody.forEach((note, i) => {
                        playNote(midiToFreq(note), 0.8, i * 1);
                    });
                } else {
                    currentMelody.forEach((note, i) => {
                        playNote(midiToFreq(note), 0.6, i * 0.4);
                    });
                }
            } else if (currentMode === 'chords' && currentChord) {
                if (chordPlayStyle === 'block') {
                    currentChord.notes.forEach(note => {
                        playNote(midiToFreq(note), 2, 0);
                    });
                } else {
                    currentChord.notes.forEach((note, i) => {
                        playNote(midiToFreq(note), 1, i * 0.3);
                    });
                }
            } else if (currentMode === 'scale-degrees' && currentScaleDegrees.length > 0) {
                let startTime = 0;
                if (playReference) {
                    playNote(midiToFreq(60), 1, 0); // Root note C4
                    startTime = 1.5;
                }
                
                if (scaleSequenceMode === 'single') {
                    playNote(midiToFreq(currentScaleDegrees[0]), 1, startTime);
                } else {
                    currentScaleDegrees.forEach((note, i) => {
                        playNote(midiToFreq(note), 0.8, startTime + (i * 1));
                    });
                }
            }
        });
        
        // Length selector
        document.querySelectorAll('.length-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.length-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                melodyLength = parseInt(btn.dataset.length);
            });
        });
        
        // Playback style selector
        document.querySelectorAll('.melody-style-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.melody-style-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                playbackStyle = btn.dataset.style;
            });
        });
        
        // Submit melody button
        document.getElementById('submit-melody-btn').addEventListener('click', () => {
            if (userMelody.length > 0) {
                checkMelody();
            }
        });
        
        // Clear melody button
        document.getElementById('clear-melody-btn').addEventListener('click', () => {
            userMelody = [];
            document.getElementById('user-melody').innerHTML = '';
            document.getElementById('submit-controls').style.display = 'none';
            document.getElementById('recording-status').textContent = 'üéπ Click the keyboard to play back the melody...';
        });
        
        // Step-through controls
        document.getElementById('next-note-btn').addEventListener('click', () => {
            if (currentStepIndex < currentMelody.length - 1) {
                currentStepIndex++;
            } else {
                // Loop back to the beginning
                currentStepIndex = 0;
            }
            playNote(midiToFreq(currentMelody[currentStepIndex]), 1, 0);
            highlightKeys([currentMelody[currentStepIndex]]);
            document.getElementById('step-status').textContent = `Note ${currentStepIndex + 1} of ${melodyLength}`;
        });
        
        document.getElementById('prev-note-btn').addEventListener('click', () => {
            if (currentStepIndex > 0) {
                currentStepIndex--;
            } else {
                // Loop to end
                currentStepIndex = currentMelody.length - 1;
            }
            playNote(midiToFreq(currentMelody[currentStepIndex]), 1, 0);
            highlightKeys([currentMelody[currentStepIndex]]);
            document.getElementById('step-status').textContent = `Note ${currentStepIndex + 1} of ${melodyLength}`;
        });
        
        document.getElementById('start-recording-btn').addEventListener('click', () => {
            document.getElementById('step-controls').style.display = 'none';
            highlightKeys([]);
            startRecording();
        });
        
        // Chord playback style selector
        document.querySelectorAll('.chord-style-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.chord-style-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                chordPlayStyle = btn.dataset.chordStyle;
            });
        });
        
        // Environment selector (for scale degrees mode)
        document.querySelectorAll('[data-env]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('[data-env]').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                selectedEnv = parseInt(btn.dataset.env);
                displayScalePattern();
                
                // Update the harmonic environment display
                const pattern = scalePatterns[selectedEnv];
                document.getElementById('env-name').textContent = `${pattern.name} (${selectedEnv})`;
                
                // Update scale degrees display
                const container = document.getElementById('scale-degrees');
                container.innerHTML = '';
                pattern.degrees.forEach(degree => {
                    const degreeEl = document.createElement('div');
                    degreeEl.className = 'degree';
                    degreeEl.textContent = degree;
                    container.appendChild(degreeEl);
                });
            });
        });
        
        // Melody environment selector
        document.querySelectorAll('.melody-env-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.melody-env-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                melodyEnv = parseInt(btn.dataset.melodyEnv);
                updateMelodyEnvDisplay();
            });
        });
        
        // Update melody environment display
        function updateMelodyEnvDisplay() {
            const pattern = scalePatterns[melodyEnv];
            document.getElementById('env-name').textContent = `${pattern.name} (${melodyEnv})`;
            
            // Update scale degrees display
            const container = document.getElementById('scale-degrees');
            container.innerHTML = '';
            pattern.degrees.forEach(degree => {
                const degreeEl = document.createElement('div');
                degreeEl.className = 'degree';
                degreeEl.textContent = degree;
                container.appendChild(degreeEl);
            });
        }
        
        // Sequence mode selector
        document.querySelectorAll('.sequence-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.sequence-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                scaleSequenceMode = btn.dataset.sequence;
            });
        });
        
        // Reference toggle
        document.querySelectorAll('.reference-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.reference-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                playReference = btn.dataset.reference === 'yes';
            });
        });
        
        // Initialize
        createKeyboard();
        createAnswerButtons();
        updateScaleDegrees();
    </script>
</body>
</html>
